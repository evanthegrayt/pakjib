#!/usr/bin/env ruby
#===============================================================#
#         File: spoonerise                                      #
#  Description: CLI executable for word-flipper                 #
#                                                               #
#       Author: Evan Gray                                       #
#===============================================================#

require 'optparse'
# Internals
require_relative '../lib/spoonerise'

USAGE = 'USAGE: %s [OPTIONS] [WORDS]...' % [File.basename(__FILE__)]

def instantiate
  yield
rescue Spoonerise::JakPibError
  abort('Please pass more flip-able words.')
end

##
# Read in args and set options
opts = {}
OptionParser.new do |o|
  o.banner = USAGE
  o.on('-r', '--[no-]reverse', 'Reverse flipping') { |v| opts[:reverse] = v }
  o.on('-l', '--[no-]lazy', 'Skip small words')    { |v| opts[:lazy]    = v }
  o.on('-m', '--[no-]map', 'Print words mapping')  { |v| opts[:map]     = v }
  o.on('-s', '--[no-]save', 'Save results in log') { |v| opts[:save]    = v }
  o.on('--exclude=WORDS', Array, 'Words to skip')  { |v| opts[:exclude] = v }
end.parse!(ARGV)

abort(USAGE) if ARGV.empty?

##
# Create instance of Flipper. I rescue the custom error and replace it with
# a more command-line friendly message.
words = instantiate { Spoonerise::Flipper.new(ARGV, opts) }

##
# If user passed `-s`, save to log file; otherwise, just print results as string
if opts[:save]
  puts "Saving [#{words.to_s}] to #{words.logfile}"
  words.save
else
  puts words.to_s
  if opts[:map]
    longest_key_size = words.to_h.max_by { |k,v| k }.first.size
    words.to_h.each { |k, v| puts "%-#{longest_key_size}s => %s" % [k, v] }
  end
end

